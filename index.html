<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monetization Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }
        .screen { display: none; }
        .active { display: block; }
        .modal, #achievement-popup {
            transition: opacity 0.3s, transform 0.3s;
        }
        .feedback-popup {
            position: absolute;
            pointer-events: none;
            animation: fade-out-up 1s forwards;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        @keyframes fade-out-up {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-30px); }
        }
        /* Style for disabled buttons */
        button:disabled {
            cursor: not-allowed;
            filter: grayscale(80%);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto max-w-4xl p-4 relative">

        <header class="bg-gray-800 text-white p-4 rounded-lg shadow-lg mb-4">
            <h1 class="text-3xl font-bold text-center">Monetization Simulator</h1>
        </header>

        <div class="bg-gray-900 text-white p-3 rounded-lg shadow-md mb-4 sticky top-2 z-50 flex justify-around items-center text-center">
            <div>
                <span class="text-sm text-gray-400">Leads</span>
                <p class="text-xl font-semibold" id="globalLeadCount">0</p>
            </div>
            <div>
                <span class="text-sm text-gray-400">Money</span>
                <p class="text-xl font-semibold">$<span id="globalMoneyCount">0.00</span></p>
            </div>
            <div>
                <span class="text-sm text-gray-400">Rate</span>
                <p class="text-xl font-semibold">$<span id="globalRate">0.00</span>/s</p>
            </div>
        </div>

        <div id="nav-buttons" class="bg-white rounded-lg shadow-md p-2 mb-4 flex flex-wrap justify-center gap-2">
            <button data-screen="salesScreen" class="px-4 py-2 rounded-md bg-blue-500 text-white font-semibold hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">Sales</button>
            <button data-screen="accountScreen" class="px-4 py-2 rounded-md bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Accounts</button>
            <button data-screen="staffScreen" class="px-4 py-2 rounded-md bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Staff</button>
            <button data-screen="upgradesScreen" class="px-4 py-2 rounded-md bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Upgrades</button>
            <button data-screen="achievementsScreen" class="px-4 py-2 rounded-md bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Achievements</button>
            <button data-screen="statsScreen" class="px-4 py-2 rounded-md bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Statistics</button>
        </div>

        <div id="salesScreen" class="screen active p-4 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">Sales Screen</h2>
            <button id="generateLeadBtn" class="w-full md:w-auto px-6 py-3 rounded-lg bg-green-500 text-white font-bold text-lg shadow-md hover:bg-green-600 transition-transform transform hover:scale-105">Generate Lead</button>
            <div id="emailText" class="mt-4 p-4 h-48 bg-gray-900 text-green-400 font-mono rounded-lg overflow-y-auto text-left whitespace-pre-wrap shadow-inner"></div>
        </div>

        <div id="accountScreen" class="screen p-4 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">Accounts Screen</h2>
            <button id="developLeadBtn" class="w-full md:w-auto px-6 py-3 rounded-lg bg-indigo-500 text-white font-bold text-lg shadow-md hover:bg-indigo-600 transition-transform transform hover:scale-105">Develop Lead</button>
            <div class="w-full bg-gray-200 rounded-full h-6 mt-4 overflow-hidden shadow-inner">
                <div id="progressBar" class="bg-indigo-600 h-6 rounded-full transition-all duration-200" style="width: 0%"></div>
            </div>
            <div id="adScriptText" class="mt-4 p-4 h-48 bg-gray-900 text-cyan-400 font-mono rounded-lg overflow-y-auto text-left whitespace-pre-wrap shadow-inner"></div>
        </div>

        <div id="staffScreen" class="screen p-4 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">Staff</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-xl font-semibold mb-2">Hired Staff</h3>
                    <ul id="hiredStaffList" class="list-disc list-inside bg-gray-100 p-3 rounded-lg min-h-[100px]"></ul>
                </div>
                <div id="staff-for-hire" class="space-y-4"></div>
            </div>
        </div>

        <div id="upgradesScreen" class="screen p-4 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">Upgrades</h2>
            <div id="upgrades-container" class="space-y-6"></div>
        </div>
        
        <div id="achievementsScreen" class="screen p-4 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">Achievements</h2>
            <div id="achievementsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            
            <div class="mt-8 border-t-2 border-gray-200 pt-6">
                <h3 class="text-xl font-bold mb-4 text-center">Settings</h3>
                <div class="max-w-md mx-auto space-y-3">
                    <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
                        <label for="toggleOfflineProgress" class="font-semibold text-gray-700">Enable Offline Progress</label>
                        <button id="toggleOfflineProgress" class="px-4 py-1 rounded-full font-semibold text-sm"></button>
                    </div>
                    <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
                        <label for="toggleStaffAnimation" class="font-semibold text-gray-700">Enable Staff Text Animation</label>
                        <button id="toggleStaffAnimation" class="px-4 py-1 rounded-full font-semibold text-sm"></button>
                    </div>
                </div>
            </div>

            <div class="mt-8 text-center space-x-4">
                <button id="manualSaveBtn" class="px-4 py-2 rounded-md bg-blue-600 text-white font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">Manual Save</button>
                <button id="resetProgressBtn" class="px-4 py-2 rounded-md bg-red-600 text-white font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400">Reset Progress</button>
            </div>
        </div>

        <div id="statsScreen" class="screen p-4 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">Statistics</h2>
            <div id="statisticsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

    </div>
    
    <div id="achievement-popup" class="fixed bottom-5 right-5 bg-gray-900 text-white p-4 rounded-lg shadow-2xl opacity-0 transform translate-y-10 pointer-events-none">
        <h3 class="font-bold text-lg text-yellow-400" id="achievement-title"></h3>
        <p class="text-sm" id="achievement-desc"></p>
    </div>

    <div id="welcome-back-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <h2 class="text-2xl font-bold mb-4">Welcome Back!</h2>
            <p>While you were away, your team earned:</p>
            <p class="text-xl font-semibold my-2" id="offline-earnings"></p>
            <button id="close-welcome-modal" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-md">Great!</button>
        </div>
    </div>

    <div id="event-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm relative mx-4">
            <button id="close-event-modal" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold mb-2" id="event-title"></h2>
            <p class="my-4" id="event-description"></p>
            <div id="event-choices" class="mt-4 space-y-2 sm:space-y-0 sm:space-x-2 flex flex-col sm:flex-row justify-center"></div>
        </div>
    </div>

    <div id="event-details-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm relative mx-4">
            <button id="close-event-details-modal" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold mb-2" id="event-details-title"></h2>
            <p class="my-4" id="event-details-description"></p>
        </div>
    </div>

    <div id="active-event-timer" class="fixed bottom-5 left-5 bg-gray-900 text-white p-3 rounded-lg shadow-2xl hidden z-40 cursor-pointer">
        <h4 class="font-bold text-md" id="active-event-title"></h4>
        <p class="text-sm text-center" id="active-event-time-left"></p>
    </div>

<script>
// --- DOM ELEMENTS ---
const DOM = {
    globalLeadCount: document.getElementById('globalLeadCount'),
    globalMoneyCount: document.getElementById('globalMoneyCount'),
    globalRate: document.getElementById('globalRate'),
    navButtons: document.getElementById('nav-buttons'),
    screens: document.querySelectorAll('.screen'),
    generateLeadBtn: document.getElementById('generateLeadBtn'),
    developLeadBtn: document.getElementById('developLeadBtn'),
    emailText: document.getElementById('emailText'),
    adScriptText: document.getElementById('adScriptText'),
    progressBar: document.getElementById('progressBar'),
    hiredStaffList: document.getElementById('hiredStaffList'),
    staffForHire: document.getElementById('staff-for-hire'),
    upgradesContainer: document.getElementById('upgrades-container'),
    achievementsList: document.getElementById('achievementsList'),
    statisticsList: document.getElementById('statisticsList'),
    manualSaveBtn: document.getElementById('manualSaveBtn'),
    resetProgressBtn: document.getElementById('resetProgressBtn'),
    toggleOfflineProgress: document.getElementById('toggleOfflineProgress'),
    toggleStaffAnimation: document.getElementById('toggleStaffAnimation'),
    // Modals & Popups
    achievementPopup: {
        el: document.getElementById('achievement-popup'),
        title: document.getElementById('achievement-title'),
        desc: document.getElementById('achievement-desc'),
    },
    welcomeModal: {
        el: document.getElementById('welcome-back-modal'),
        earnings: document.getElementById('offline-earnings'),
        closeBtn: document.getElementById('close-welcome-modal'),
    },
    eventModal: {
        el: document.getElementById('event-modal'),
        title: document.getElementById('event-title'),
        description: document.getElementById('event-description'),
        choices: document.getElementById('event-choices'),
        closeBtn: document.getElementById('close-event-modal'),
    },
    eventDetailsModal: {
        el: document.getElementById('event-details-modal'),
        title: document.getElementById('event-details-title'),
        description: document.getElementById('event-details-description'),
        closeBtn: document.getElementById('close-event-details-modal'),
    },
    activeEventTimer: {
        el: document.getElementById('active-event-timer'),
        title: document.getElementById('active-event-title'),
        timeLeft: document.getElementById('active-event-time-left'),
    }
};

// --- GAME DATA ---
const staffData = {
    sales: {
        name: 'Sales',
        cost: 5,
        costMultiplier: 3.5,
        members: ['Artyom', 'Alan', 'Aruna', 'Dora', 'Syrym', 'Aidos', 'Alimzhan', 'Anna', 'Bolat', 'Yerbol', 'Madi'],
    },
    accounts: {
        name: 'Accounts',
        cost: 5,
        costMultiplier: 3.5,
        members: ['Azret', 'Asiya', 'Daniil', 'Aizhan', 'Amir', 'Akzhan', 'Anuar', 'Hakim', 'Saniya', 'Sanzhar'],
    },
    products: {
        name: 'Products',
        cost: 100,
        costMultiplier: 1, // No multiplier for single member
        members: ['Emil'],
    }
};

const upgradeData = {
    sales: {
        name: 'Sales Upgrades',
        upgrades: {
            betterLeadForms: { name: 'Better Lead Forms', desc: (g) => `Increases manual lead gen chance by ${(g.upgrades.betterLeadForms.chanceIncrease * 100).toFixed(1)}pp. Current: ${(g.getLeadChance() * 100).toFixed(2)}%`, cost: 1, costMultiplier: 5, maxLevel: 0, chanceIncrease: 0.005, onPurchase: (g) => { g.upgrades.betterLeadForms.level++; } },
            leadMagnet: { name: 'Lead Magnet', desc: (g) => `Manual clicks generate ${g.upgrades.leadMagnet.multiplier}x leads.`, cost: 50, costMultiplier: 10, maxLevel: 0, multiplier: 1, onPurchase: (g) => { g.upgrades.leadMagnet.level++; g.upgrades.leadMagnet.multiplier *= 2; } },
            betterEmailSubject: { name: 'Better Email Subject', desc: (g) => `+1% bonus lead chance per Sales staff.`, cost: 20, costMultiplier: 3, maxLevel: 0, onPurchase: (g) => { g.upgrades.betterEmailSubject.level++; } },
            referralProgram: { name: 'Referral Program', desc: (g) => `Passively generate ${g.upgrades.referralProgram.level} lead(s) every 10 seconds.`, cost: 15, costMultiplier: 3, maxLevel: 0, onPurchase: (g) => { g.upgrades.referralProgram.level++; } },
            aggressiveFollowup: { name: 'Aggressive Followup', desc: (g) => `+5% chance per click to instantly develop a lead. Current: ${(g.upgrades.aggressiveFollowup.chance * 100).toFixed(0)}%`, cost: 7, costMultiplier: 3, maxLevel: 0, chance: 0, onPurchase: (g) => { g.upgrades.aggressiveFollowup.level++; g.upgrades.aggressiveFollowup.chance += 0.05; } },
        }
    },
    accounts: {
        name: 'Accounts Upgrades',
        upgrades: {
            asiyasHelp: { name: 'Asiya’s Help', desc: (g) => `Reduces clicks needed to develop a lead by ${g.upgrades.asiyasHelp.clicksReduction}. Current: ${g.clicksToDevelopLead}`, cost: 3, costMultiplier: 5, maxLevel: 0, clicksReduction: 15, onPurchase: (g) => { g.upgrades.asiyasHelp.level++; g.clicksToDevelopLead = Math.max(10, g.clicksToDevelopLead - g.upgrades.asiyasHelp.clicksReduction); }, isMaxed: (g) => g.clicksToDevelopLead <= 10 },
            secondMonitor: { name: '2nd Monitor', desc: () => `Each manual click on "Develop Lead" counts as two.`, cost: 10, oneTime: true, onPurchase: (g) => { g.upgrades.secondMonitor.purchased = true; } },
            newAdNetworks: { name: 'New Ad Networks', desc: (g) => `Each developed lead earns +$${g.upgrades.newAdNetworks.incomeBonus.toFixed(2)} more. Current: $${g.incomePerLead.toFixed(2)}`, cost: 10, costMultiplier: 2, maxLevel: 0, incomeBonus: 0.01, onPurchase: (g) => { g.upgrades.newAdNetworks.level++; g.incomePerLead += g.upgrades.newAdNetworks.incomeBonus; } },
            backgroundMusic: { name: 'Background Music', desc: (g) => `+${g.upgrades.backgroundMusic.level} click/sec to each Accounts staff.`, cost: 80, costMultiplier: 15, maxLevel: 0, onPurchase: (g) => { g.upgrades.backgroundMusic.level++; } },
            cpmOptimization: { name: 'CPM Optimization', desc: (g) => `${(g.upgrades.cpmOptimization.chance * 100).toFixed(0)}% chance to double money from a lead.`, cost: 500, costMultiplier: 3, maxLevel: 0, chance: 0, onPurchase: (g) => { g.upgrades.cpmOptimization.level++; g.upgrades.cpmOptimization.chance = Math.min(1, g.upgrades.cpmOptimization.chance + 0.2); }, isMaxed: (g) => g.upgrades.cpmOptimization.chance >= 1 },
        }
    },
    global: {
        name: 'Global Upgrades',
        upgrades: {
            nytPuzzles: { name: 'NYT Puzzles', desc: (g) => `Boosts Sales/Account upgrade effectiveness by x1.5.`, cost: 15, oneTime: true, onPurchase: (g) => { g.upgrades.nytPuzzles.purchased = true; g.upgrades.betterLeadForms.chanceIncrease *= 1.5; g.upgrades.asiyasHelp.clicksReduction = Math.round(g.upgrades.asiyasHelp.clicksReduction * 1.5); } },
            corporateCulture: { name: 'Corporate Culture', desc: () => `All manual clicks count as two.`, cost: 50, oneTime: true, onPurchase: (g) => { g.upgrades.corporateCulture.purchased = true; } },
            sycGlobal: { name: 'СУЦ', desc: () => `All income from developing leads is increased by 20%.`, cost: 250, oneTime: true, multiplier: 1.2, onPurchase: (g) => { g.upgrades.sycGlobal.purchased = true; } },
            amirsAutomation: { name: 'Amir’s Automation', desc: () => `Automated staff work twice as fast.`, cost: 5000, oneTime: true, onPurchase: (g) => { g.upgrades.amirsAutomation.purchased = true; } },
            coffeeMachine: { name: 'Coffee Machine', desc: () => `Allows holding down the mouse button to click rapidly.`, cost: 100, oneTime: true, onPurchase: (g) => { g.upgrades.coffeeMachine.purchased = true; g.applyCoffeeMachineListeners(); } },
        }
    }
};

const achievementData = {
    mukhtarSatisfied: { name: "Mukhtar is satisfied", description: "Earn $50 total.", condition: (g) => g.stats.totalMoneyEarned >= 50 },
    mukhtarHappy: { name: "Mukhtar is happy", description: "Earn $100 total.", condition: (g) => g.stats.totalMoneyEarned >= 100 },
    mukhtarReallyHappy: { name: "Mukhtar is REALLY happy", description: "Earn $1,000 total.", condition: (g) => g.stats.totalMoneyEarned >= 1000 },
    someonePromoted: { name: "Someone is getting promoted", description: "Earn $5,000 total.", condition: (g) => g.stats.totalMoneyEarned >= 5000 },
    syc: { name: "100% СУЦ", description: "Earn $10,000 total.", condition: (g) => g.stats.totalMoneyEarned >= 10000 },
    carpalTunnel: { name: "Carpal Tunnel Syndrome", description: "Manually click 10,000 times.", condition: (g) => g.stats.totalManualClicks >= 10000 },
    buyMyUSDT: { name: "Buy my USDT", description: "Hire Emil.", condition: (g) => g.hiredStaff.has('Emil') },
    salesDivision: { name: "Sales Division Assembled", description: "Hire every staff member from the Sales department.", condition: (g) => staffData.sales.members.every(name => g.hiredStaff.has(name)) },
    accountsDivision: { name: "Accounts Division Assembled", description: "Hire every staff member from the Accounts department.", condition: (g) => staffData.accounts.members.every(name => g.hiredStaff.has(name)) },
    peakEfficiency: { name: "Peak Efficiency", description: "Purchase all of the one-time Global Upgrades.", condition: (g) => Object.keys(upgradeData.global.upgrades).every(key => g.upgrades[key].purchased) },
    shapkaGang: { name: "Шапка gang", description: "Hire all staff.", condition: (g) => {
        const totalStaff = Object.values(staffData).reduce((sum, type) => sum + type.members.length, 0);
        return g.hiredStaff.size === totalStaff;
    }},
    crisisAverted: { name: "Crisis Averted", description: "Successfully navigate a \"Server Crash\" event by waiting it out instead of paying.", condition: (g) => g.stats.waitedOutServerCrash }
};

const emailContent = `Dear Valued Client,\n\nWe hope this message finds you well. I'm writing to follow up on our previous conversation regarding the exciting monetization opportunities available to you...`;
const adScriptContent = `// Monetization Script\nfunction showAd() {\n  const ad = document.createElement('div');\n  ad.className = 'ad-banner';\n  ad.innerText = 'This space is monetized!';\n  document.body.appendChild(ad);\n}\nsetInterval(showAd, 5000);`;

const eventData = {
    viralMarketing: {
        title: "Viral Marketing Campaign",
        description: (name) => `${name}’s latest email campaign went viral on social media! The leads are pouring in.`,
        effectDescription: "For the next 60 seconds, every lead generation action produces 5x the normal amount of leads.",
        duration: 60,
        type: 'good'
    },
    bullMarket: {
        title: "Bull Market",
        description: () => "The market is hot! Advertisers are paying a premium for ad space.",
        effectDescription: "All income from developing leads is doubled for the next 90 seconds.",
        duration: 90,
        type: 'good'
    },
    productivityGuru: {
        title: "Productivity Guru Visits",
        description: () => "A famous инфоцыган visited the office and motivated the team!",
        effectDescription: "All staff members work 50% faster for the next 3 minutes.",
        duration: 180,
        type: 'good'
    },
    foundInvoice: {
        title: "Found an Old Invoice",
        description: (name) => `While cleaning out a filing cabinet, ${name} found an old, unpaid invoice from a client.`,
        effectDescription: "Instantly gain a lump sum of money equal to 10% of your current balance.",
        duration: 0,
        type: 'good'
    },
    abTest: {
        title: "Successful A/B Test",
        description: (name) => `${name} ran an A/B test on a new ad format, and it's a huge success!`,
        effectDescription: "The base income per lead is temporarily increased by +$0.50 for the next 2 minutes.",
        duration: 120,
        type: 'good',
        onStart: (g) => { g.incomePerLead += 0.5; },
        onEnd: (g) => { g.incomePerLead -= 0.5; }
    },
    serverCrash: {
        title: "Server Crash!",
        description: () => "Oh no! Reports has crashed, halting all operations.",
        type: 'choice',
        choices: [
            { text: "Pay $500", action: (g) => { if(g.money >= 500) { g.money -= 500; } else { g.startEvent('serverCrashPenalty'); } } },
            { text: "Wait 60s", action: (g) => { g.startEvent('serverCrashPenalty'); g.stats.waitedOutServerCrash = true; } }
        ]
    },
    serverCrashPenalty: {
        title: "Server Down",
        effectDescription: "All income and lead development is halted.",
        duration: 60,
        type: 'bad'
    },
    adNetworkOutage: {
        title: "Ad Network Outage",
        description: () => "One of your biggest ad networks is experiencing a global outage.",
        effectDescription: "The money earned per lead is halved for the next 90 seconds.",
        duration: 90,
        type: 'bad',
        onStart: (g) => { g.incomePerLead /= 2; },
        onEnd: (g) => { g.incomePerLead *= 2; }
    },
    teamBurnout: {
        title: "Team Burnout",
        description: (name) => `${name} is feeling overworked and exhausted after a long week.`,
        effectDescription: "All staff members work 25% slower for the next 3 minutes.",
        duration: 180,
        type: 'bad'
    },
    officeExpense: {
        title: "Unexpected Office Expense",
        description: () => "The water cooler broke down and needs an immediate, expensive repair!",
        effectDescription: "Instantly lose 5% of your current money.",
        duration: 0,
        type: 'bad'
    },
    negativePR: {
        title: "Negative PR",
        description: () => "A competitor published a negative article about your company, hurting your reputation.",
        effectDescription: "Your chance to generate a lead is reduced by 50% for the next 2 minutes.",
        duration: 120,
        type: 'bad',
        onStart: (g) => { g.leadGenerationChance /= 2; },
        onEnd: (g) => { g.leadGenerationChance *= 2; }
    }
};


// --- GAME STATE & LOGIC ---
class MonetizationGame {
    constructor() {
        this.isProcessingClick = false;
        this.load(); // Load game state or set defaults
        this.activeIntervals = [];
        this.holdInterval = null;
    }

    // --- State Management ---
    getDefaultState() {
        return {
            leads: 0,
            money: 0,
            developClicks: 0,
            incomePerLead: 0.02,
            incomeRate: 0,
            clicksToDevelopLead: 100,
            hiredStaff: new Set(),
            staffCosts: {
                sales: staffData.sales.cost,
                accounts: staffData.accounts.cost,
                products: staffData.products.cost
            },
            upgrades: this.getInitialUpgradeState(),
            achievements: this.getInitialAchievementState(),
            stats: {
                totalMoneyEarned: 0,
                totalManualClicks: 0,
                totalLeadsGenerated: 0,
                playTime: 0,
                waitedOutServerCrash: false,
            },
            settings: {
                offlineProgress: false,
                staffTextAnimation: true
            },
            lastSavedTime: Date.now(),
            activeEvent: null,
            eventCooldown: 180,
            // Non-saved transient state
            emailCharIndex: 0,
            adCharIndex: 0,
        };
    }

    getInitialUpgradeState() {
        const state = {};
        for (const category in upgradeData) {
            for (const key in upgradeData[category].upgrades) {
                const u = upgradeData[category].upgrades[key];
                state[key] = u.oneTime ? { purchased: false } : { level: 0, ...u };
            }
        }
        return state;
    }

    getInitialAchievementState() {
        const state = {};
        for (const key in achievementData) {
            state[key] = { unlocked: false };
        }
        return state;
    }

    save() {
        const stateToSave = { ...this };
        delete stateToSave.activeIntervals;
        delete stateToSave.holdInterval;
        stateToSave.hiredStaff = Array.from(this.hiredStaff);
        stateToSave.lastSavedTime = Date.now();
        localStorage.setItem('monetizationSimSave_v2', JSON.stringify(stateToSave));
    }

    load() {
        const savedData = localStorage.getItem('monetizationSimSave_v2');
        const defaultState = this.getDefaultState();

        if (savedData) {
            try {
                const savedState = JSON.parse(savedData);
                // Start with the default state to ensure all properties exist
                Object.assign(this, defaultState);
                // Overwrite with saved top-level properties
                Object.assign(this, savedState);

                // Perform a deep merge for nested objects to prevent issues with old saves
                this.hiredStaff = new Set(savedState.hiredStaff || []);
                
                const defaultUpgrades = defaultState.upgrades;
                const savedUpgrades = savedState.upgrades || {};
                const mergedUpgrades = {};
                for (const key in defaultUpgrades) {
                    if (defaultUpgrades.hasOwnProperty(key)) {
                        mergedUpgrades[key] = { ...defaultUpgrades[key], ...(savedUpgrades[key] || {}) };
                    }
                }
                this.upgrades = mergedUpgrades;

                this.achievements = { ...defaultState.achievements, ...savedState.achievements };
                this.stats = { ...defaultState.stats, ...savedState.stats };
                this.staffCosts = { ...defaultState.staffCosts, ...savedState.staffCosts };
                this.settings = { ...defaultState.settings, ...savedState.settings };

                this.handleOfflineProgress(savedState.lastSavedTime || Date.now());
            } catch (error) {
                console.error("Failed to load saved data, starting fresh.", error);
                Object.assign(this, defaultState);
            }
        } else {
            Object.assign(this, defaultState);
        }
    }
    
    handleOfflineProgress(lastSavedTime) {
        if (!this.settings.offlineProgress) return;

        const timeDiffSeconds = Math.floor((Date.now() - (lastSavedTime || Date.now())) / 1000);
        if (timeDiffSeconds > 5) {
            const offlineEarnings = (this.incomeRate || 0) * timeDiffSeconds * 0.5;
            if (offlineEarnings > 0) {
                this.money += offlineEarnings;
                this.stats.totalMoneyEarned += offlineEarnings;
                this.showWelcomeBackModal(offlineEarnings);
            }
        }
    }

    reset() {
        if (confirm("Are you sure you want to reset all your progress? This cannot be undone.")) {
            localStorage.removeItem('monetizationSimSave_v2');
            location.reload();
        }
    }

    // --- Core Gameplay ---
    getLeadChance() {
        let chance = 0.02; // Increased base chance
        chance += this.upgrades.betterLeadForms.level * this.upgrades.betterLeadForms.chanceIncrease;
        chance += 0.01 * this.getStaffCount('sales') * this.upgrades.betterEmailSubject.level;
        if (this.activeEvent && this.activeEvent.key === 'negativePR') {
            chance /= 2;
        }
        return chance;
    }

    getPassiveIncome() {
        return this.incomeRate;
    }

    tryGenerateLead(isManualClick = false) {
        if (isManualClick) {
            this.stats.totalManualClicks++;
        }

        if (isManualClick || this.settings.staffTextAnimation) {
            if (this.emailCharIndex >= emailContent.length) {
                this.emailCharIndex = 0;
            }
            this.emailCharIndex++;
        }

        const performAction = () => {
            if (Math.random() < this.getLeadChance()) {
                let leadsGained = this.upgrades.leadMagnet.multiplier;
                if (this.activeEvent && this.activeEvent.key === 'viralMarketing') {
                    leadsGained *= 5;
                }
                this.leads += leadsGained;
                this.stats.totalLeadsGenerated += leadsGained;
                if (isManualClick) this.createFeedbackPopup(`+${leadsGained} Lead`, DOM.generateLeadBtn);
            }
            if (isManualClick && Math.random() < this.upgrades.aggressiveFollowup.chance) {
                this.developLead(false);
            }
        };

        const clickMultiplier = isManualClick && this.upgrades.corporateCulture.purchased ? 2 : 1;
        for (let i = 0; i < clickMultiplier; i++) performAction();
        
        if (isManualClick) {
            this.updateSalesScreen();
            this.updateGlobalStats();
        }
    }

    developLead(isManualClick = false) {
        if (this.leads <= 0) {
            if (isManualClick) {
                 if (this.adCharIndex >= adScriptContent.length) {
                    this.adCharIndex = 0;
                }
                this.adCharIndex++;
                this.updateAccountScreen();
            }
            return;
        }
        
        if (isManualClick) {
            this.stats.totalManualClicks++;
        }

        if (isManualClick || this.settings.staffTextAnimation) {
            if (this.adCharIndex >= adScriptContent.length) {
                this.adCharIndex = 0;
            }
            this.adCharIndex++;
        }

        let clickMultiplier = 1;
        if (isManualClick) {
            if (this.upgrades.secondMonitor.purchased) clickMultiplier *= 2;
            if (this.upgrades.corporateCulture.purchased) clickMultiplier *= 2;
        }
        this.developClicks += clickMultiplier;

        while (this.developClicks >= this.clicksToDevelopLead && this.leads > 0) {
            const incomeFromLead = this.getIncomeFromLead();
            this.incomeRate += incomeFromLead;
            this.developClicks -= this.clicksToDevelopLead;
            this.leads--;
            if (isManualClick) this.createFeedbackPopup(`+$${incomeFromLead.toFixed(2)}/s`, DOM.developLeadBtn);
        }
        
        if (isManualClick) {
            this.updateAccountScreen();
            this.updateGlobalStats();
        }
    }
    
    getIncomeFromLead() {
        let income = this.incomePerLead;
        if (this.upgrades.sycGlobal.purchased) income *= this.upgrades.sycGlobal.multiplier;
        if (Math.random() < this.upgrades.cpmOptimization.chance) income *= 2;
        if (this.activeEvent && this.activeEvent.key === 'bullMarket') income *= 2;
        if (this.activeEvent && this.activeEvent.key === 'adNetworkOutage') income /= 2;
        return income;
    }

    hireStaff(type, name) {
        if (this.isProcessingClick) return;
        this.isProcessingClick = true;
        try {
            const cost = this.staffCosts[type];
            if (this.money < cost) {
                return;
            }
            this.money -= cost;
            this.hiredStaff.add(name);
            this.staffCosts[type] *= staffData[type].costMultiplier;

            if (type === 'products') {
                this.incomeRate += 5;
            }

            this.restartIntervals();
            this.renderAll();
            this.checkAchievements();
        } finally {
            this.isProcessingClick = false;
        }
    }

    buyUpgrade(categoryKey, upgradeKey) {
        if (this.isProcessingClick) return;
        this.isProcessingClick = true;
        try {
            const upgradeDef = upgradeData[categoryKey].upgrades[upgradeKey];
            const upgradeState = this.upgrades[upgradeKey];
            const cost = upgradeDef.oneTime ? upgradeDef.cost : upgradeState.cost;

            if (this.money < cost) {
                return;
            }
            this.money -= cost;
            upgradeDef.onPurchase(this);

            if (!upgradeDef.oneTime) {
                upgradeState.cost *= upgradeDef.costMultiplier;
            }

            this.restartIntervals();
            this.renderAll();
        } finally {
            this.isProcessingClick = false;
        }
    }
    
    isStaffUnlocked(name) {
        if (name === 'Azret') return true;
        if (name === 'Artyom') return this.hiredStaff.has('Azret');
        if (name === 'Asiya') return this.hiredStaff.has('Artyom');
        if (name === 'Emil') return this.hiredStaff.has('Asiya');

        // All other staff are unlocked after Asiya
        if (name !== 'Azret' && name !== 'Artyom' && name !== 'Asiya' && name !== 'Emil') {
            return this.hiredStaff.has('Asiya');
        }
        return false;
    }

    // --- UI & Rendering ---
    renderAll() {
        this.updateGlobalStats();
        this.updateSalesScreen();
        this.updateAccountScreen();
        this.renderStaff();
        this.renderUpgrades();
        this.renderAchievements();
        this.renderStatistics();
        this.renderSettings();
    }

    updateGlobalStats() {
        DOM.globalLeadCount.textContent = this.leads;
        DOM.globalMoneyCount.textContent = this.money.toFixed(2);
        DOM.globalRate.textContent = this.getPassiveIncome().toFixed(2);
    }
    
    updateSalesScreen() {
        DOM.emailText.textContent = emailContent.substring(0, this.emailCharIndex);
    }

    updateAccountScreen() {
        DOM.adScriptText.textContent = adScriptContent.substring(0, this.adCharIndex);
        const progress = this.clicksToDevelopLead > 0 ? (this.developClicks / this.clicksToDevelopLead) * 100 : 0;
        DOM.progressBar.style.width = `${progress}%`;
    }

    renderStaff() {
        DOM.hiredStaffList.innerHTML = '';
        this.hiredStaff.forEach(staffName => {
            const li = document.createElement('li');
            const type = Object.keys(staffData).find(t => staffData[t].members.includes(staffName));
            li.textContent = `${staffName} (${staffData[type].name})`;
            li.className = 'text-gray-700';
            DOM.hiredStaffList.appendChild(li);
        });

        DOM.staffForHire.innerHTML = '';
        for (const typeKey in staffData) {
            const typeInfo = staffData[typeKey];
            
            const unlockedMembers = typeInfo.members.filter(name => this.isStaffUnlocked(name));
            if (unlockedMembers.length === 0) continue;

            const categoryDiv = document.createElement('div');
            categoryDiv.innerHTML = `<h3 class="text-xl font-semibold mb-2">${typeInfo.name}</h3>`;
            const listDiv = document.createElement('div');
            listDiv.className = 'staff-list flex flex-wrap gap-2';

            unlockedMembers.forEach(name => {
                const btn = document.createElement('button');
                btn.className = 'px-3 py-1.5 rounded-md bg-yellow-400 text-yellow-900 font-semibold hover:bg-yellow-500 text-sm';
                btn.dataset.type = typeKey;
                btn.dataset.name = name;
                
                if (this.hiredStaff.has(name)) {
                    btn.textContent = 'Hired';
                    btn.disabled = true;
                } else {
                    btn.textContent = `Hire ${name} ($${this.staffCosts[typeKey].toFixed(2)})`;
                    btn.disabled = this.money < this.staffCosts[typeKey];
                }
                listDiv.appendChild(btn);
            });
            categoryDiv.appendChild(listDiv);
            DOM.staffForHire.appendChild(categoryDiv);
        }
    }

    renderUpgrades() {
        DOM.upgradesContainer.innerHTML = '';
        for (const categoryKey in upgradeData) {
            const category = upgradeData[categoryKey];
            const categoryDiv = document.createElement('div');
            categoryDiv.innerHTML = `<h3 class="text-xl font-semibold border-b-2 border-gray-200 pb-2 mb-3">${category.name}</h3>`;
            const listDiv = document.createElement('div');
            listDiv.className = 'space-y-3';
            listDiv.dataset.category = categoryKey;

            for (const upgradeKey in category.upgrades) {
                const upgradeDef = category.upgrades[upgradeKey];

                if (upgradeKey === 'cpmOptimization' && !this.hiredStaff.has('Amir')) {
                    continue; 
                }

                const upgradeState = this.upgrades[upgradeKey];
                
                const isPurchased = upgradeDef.oneTime && upgradeState.purchased;
                const isMaxed = upgradeDef.isMaxed && upgradeDef.isMaxed(this);
                const cost = upgradeDef.oneTime ? upgradeDef.cost : upgradeState.cost;

                const item = document.createElement('div');
                item.className = 'bg-gray-50 p-4 rounded-lg shadow-sm flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <h4 class="font-bold text-lg">${upgradeDef.name} ${!upgradeDef.oneTime ? `<span class="text-sm font-normal bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full">${upgradeState.level}</span>` : ''}</h4>
                        <p class="text-sm text-gray-600">${upgradeDef.desc(this)}</p>
                    </div>
                    <div class="text-right flex-shrink-0 ml-4">
                        <button data-upgrade="${upgradeKey}" class="px-4 py-2 rounded-md bg-blue-500 text-white font-semibold hover:bg-blue-600">Buy</button>
                        <p class="text-sm font-semibold mt-1">Cost: $${cost.toFixed(2)}</p>
                    </div>`;
                
                const button = item.querySelector('button');
                if (isPurchased || isMaxed || this.money < cost) {
                    button.disabled = true;
                    if(isPurchased) button.textContent = 'Purchased';
                    if(isMaxed) button.textContent = 'Maxed';
                }
                listDiv.appendChild(item);
            }
            categoryDiv.appendChild(listDiv);
            DOM.upgradesContainer.appendChild(categoryDiv);
        }
    }
    
    renderAchievements() {
        DOM.achievementsList.innerHTML = '';
        for (const key in achievementData) {
            const achDef = achievementData[key];
            const achState = this.achievements[key];
            const item = document.createElement('div');
            item.className = 'p-4 rounded-lg shadow-sm transition-all';
            if (achState.unlocked) {
                item.classList.add('bg-yellow-100', 'border', 'border-yellow-400');
                item.innerHTML = `<h4 class="font-bold text-yellow-800">${achDef.name}</h4><p class="text-sm text-yellow-700">${achDef.description}</p>`;
            } else {
                item.classList.add('bg-gray-200');
                item.innerHTML = `<h4 class="font-bold text-gray-500">Locked</h4><p class="text-sm text-gray-400">???</p>`;
            }
            DOM.achievementsList.appendChild(item);
        }
    }

    renderStatistics() {
        DOM.statisticsList.innerHTML = '';
        const createStat = (label, value) => {
            const statDiv = document.createElement('div');
            statDiv.className = 'bg-gray-200 p-3 rounded-lg';
            statDiv.innerHTML = `<span class="font-semibold">${label}:</span> ${value}`;
            DOM.statisticsList.appendChild(statDiv);
        };
        const formatTime = (seconds) => {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        };
        createStat('Total Money Earned', `$${this.stats.totalMoneyEarned.toFixed(2)}`);
        createStat('Total Leads Generated', this.stats.totalLeadsGenerated);
        createStat('Manual Clicks', this.stats.totalManualClicks);
        createStat('Play Time', formatTime(this.stats.playTime));
    }

    renderSettings() {
        if (this.settings.offlineProgress) {
            DOM.toggleOfflineProgress.textContent = 'ON';
            DOM.toggleOfflineProgress.className = 'px-4 py-1 rounded-full font-semibold text-sm bg-green-500 text-white';
        } else {
            DOM.toggleOfflineProgress.textContent = 'OFF';
            DOM.toggleOfflineProgress.className = 'px-4 py-1 rounded-full font-semibold text-sm bg-red-500 text-white';
        }

        if (this.settings.staffTextAnimation) {
            DOM.toggleStaffAnimation.textContent = 'ON';
            DOM.toggleStaffAnimation.className = 'px-4 py-1 rounded-full font-semibold text-sm bg-green-500 text-white';
        } else {
            DOM.toggleStaffAnimation.textContent = 'OFF';
            DOM.toggleStaffAnimation.className = 'px-4 py-1 rounded-full font-semibold text-sm bg-red-500 text-white';
        }
    }

    // --- Achievements & Popups ---
    checkAchievements() {
        let changed = false;
        for (const key in achievementData) {
            if (!this.achievements[key].unlocked && achievementData[key].condition(this)) {
                this.achievements[key].unlocked = true;
                this.showAchievementPopup(achievementData[key]);
                changed = true;
            }
        }
        if (changed) this.renderAchievements();
    }

    showAchievementPopup(achievement) {
        const popup = DOM.achievementPopup;
        popup.title.textContent = achievement.name;
        popup.desc.textContent = achievement.description;
        popup.el.classList.remove('opacity-0', 'translate-y-10');
        popup.el.classList.add('opacity-100', 'translate-y-0');
        setTimeout(() => {
            popup.el.classList.remove('opacity-100', 'translate-y-0');
            popup.el.classList.add('opacity-0', 'translate-y-10');
        }, 4000);
    }
    
    showWelcomeBackModal(earnings) {
        DOM.welcomeModal.earnings.textContent = `$${earnings.toFixed(2)}`;
        DOM.welcomeModal.el.classList.remove('hidden');
    }

    createFeedbackPopup(text, element) {
        const rect = element.getBoundingClientRect();
        const popup = document.createElement('div');
        popup.textContent = text;
        popup.className = 'feedback-popup font-bold text-lg';
        popup.style.left = `${rect.left + rect.width / 2 - 20}px`;
        popup.style.top = `${rect.top - 30}px`;
        popup.style.color = text.includes('+') ? (text.includes('$') ? '#10B981' : '#84CC16') : '#EF4444';
        document.body.appendChild(popup);
        setTimeout(() => popup.remove(), 1000);
    }

    // --- Event System ---
    triggerRandomEvent() {
        if (this.hiredStaff.size === 0) return;
        const eventKeys = Object.keys(eventData).filter(k => eventData[k].type !== 'bad' || this.hiredStaff.size > 2);
        const randomKey = eventKeys[Math.floor(Math.random() * eventKeys.length)];
        const event = eventData[randomKey];
        
        let description = event.description();
        if (['viralMarketing', 'teamBurnout'].includes(randomKey)) {
            const staff = [...this.hiredStaff].filter(s => staffData.sales.members.includes(s));
            description = staff.length > 0 ? event.description(staff[Math.floor(Math.random() * staff.length)]) : event.description("Someone");
        }
        if (['foundInvoice', 'abTest'].includes(randomKey)) {
            const staff = [...this.hiredStaff].filter(s => staffData.accounts.members.includes(s));
            description = staff.length > 0 ? event.description(staff[Math.floor(Math.random() * staff.length)]) : event.description("Someone");
        }

        DOM.eventModal.title.textContent = event.title;
        DOM.eventModal.description.textContent = description;
        DOM.eventModal.choices.innerHTML = '';

        if (event.type === 'choice') {
            event.choices.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice.text;
                button.className = 'px-4 py-2 rounded-md bg-gray-300 hover:bg-gray-400';
                button.onclick = () => {
                    choice.action(this);
                    DOM.eventModal.el.classList.add('hidden');
                };
                DOM.eventModal.choices.appendChild(button);
            });
        } else {
            const okButton = document.createElement('button');
            okButton.textContent = "Okay";
            okButton.className = 'px-4 py-2 rounded-md bg-blue-500 text-white hover:bg-blue-600';
            okButton.onclick = () => {
                this.startEvent(randomKey);
                DOM.eventModal.el.classList.add('hidden');
            };
            DOM.eventModal.choices.appendChild(okButton);
        }
        
        DOM.eventModal.el.classList.remove('hidden');
        this.eventCooldown = 180 + Math.random() * 120; // 3-5 minutes
    }

    startEvent(key) {
        const event = eventData[key];
        if (event.onStart) event.onStart(this);
        
        if (event.duration > 0) {
            this.activeEvent = { key: key, timeLeft: event.duration };
            this.updateActiveEventTimer();
            DOM.activeEventTimer.el.classList.remove('hidden');
            this.restartIntervals(); // Restart to apply speed changes
        } else {
            // Instant effects
            if (key === 'foundInvoice') this.money += this.money * 0.10;
            if (key === 'officeExpense') this.money *= 0.95;
        }
    }

    endEvent() {
        if (!this.activeEvent) return;
        const event = eventData[this.activeEvent.key];
        if (event.onEnd) event.onEnd(this);
        this.activeEvent = null;
        DOM.activeEventTimer.el.classList.add('hidden');
        this.restartIntervals(); // Restart to remove speed changes
    }

    updateActiveEventTimer() {
        if (!this.activeEvent) return;
        const event = eventData[this.activeEvent.key];
        DOM.activeEventTimer.title.textContent = event.title;
        const minutes = Math.floor(this.activeEvent.timeLeft / 60);
        const seconds = (this.activeEvent.timeLeft % 60).toString().padStart(2, '0');
        DOM.activeEventTimer.timeLeft.textContent = `${minutes}:${seconds}`;
    }
    
    showEventDetails() {
        if (!this.activeEvent) return;
        const event = eventData[this.activeEvent.key];
        DOM.eventDetailsModal.title.textContent = event.title;
        DOM.eventDetailsModal.description.textContent = event.effectDescription;
        DOM.eventDetailsModal.el.classList.remove('hidden');
    }

    // --- Game Loop & Intervals ---
    mainLoop() {
        let incomeThisTick = this.incomeRate;
        if (this.activeEvent && this.activeEvent.key === 'serverCrashPenalty') {
            incomeThisTick = 0;
        }
        this.money += incomeThisTick;
        this.stats.totalMoneyEarned += incomeThisTick;

        if (this.activeEvent) {
            this.activeEvent.timeLeft--;
            this.updateActiveEventTimer();
            if (this.activeEvent.timeLeft <= 0) {
                this.endEvent();
            }
        } else if (this.hiredStaff.size > 0) {
            this.eventCooldown--;
            if (this.eventCooldown <= 0) {
                this.triggerRandomEvent();
            }
        }
        
        this.stats.playTime++;
        this.checkAchievements();
        this.renderAll();
        this.save();
    }

    restartIntervals() {
        this.activeIntervals.forEach(clearInterval);
        this.activeIntervals = [];

        let baseSpeed = 500;
        if (this.upgrades.amirsAutomation.purchased) {
            baseSpeed /= 2;
        }
        if (this.activeEvent) {
            if (this.activeEvent.key === 'productivityGuru') baseSpeed *= 0.5;
            if (this.activeEvent.key === 'teamBurnout') baseSpeed *= 1.25;
        }
        
        const salesStaffSpeed = baseSpeed * 1.5;
        const accountsStaffSpeed = baseSpeed;

        const salesStaffCount = this.getStaffCount('sales');
        for (let i = 0; i < salesStaffCount; i++) {
            this.activeIntervals.push(setInterval(() => this.tryGenerateLead(false), salesStaffSpeed));
        }
        
        const accountsStaffCount = this.getStaffCount('accounts');
        for (let i = 0; i < accountsStaffCount; i++) {
            this.activeIntervals.push(setInterval(() => this.developLead(false), accountsStaffSpeed));
        }

        if (this.upgrades.referralProgram.level > 0) {
            this.activeIntervals.push(setInterval(() => { this.leads += this.upgrades.referralProgram.level; }, 10000));
        }
        if (this.upgrades.backgroundMusic.level > 0) {
            this.activeIntervals.push(setInterval(() => {
                const clicks = this.getStaffCount('accounts') * this.upgrades.backgroundMusic.level;
                for (let i = 0; i < clicks; i++) this.developLead(false);
            }, 1000));
        }
    }
    
    getStaffCount(type) {
        let count = 0;
        this.hiredStaff.forEach(name => {
            if (staffData[type].members.includes(name)) {
                count++;
            }
        });
        return count;
    }

    // --- Event Listeners ---
    setupEventListeners() {
        DOM.navButtons.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                this.showScreen(e.target.dataset.screen);
            }
        });

        DOM.generateLeadBtn.addEventListener('click', () => this.tryGenerateLead(true));
        DOM.developLeadBtn.addEventListener('click', () => this.developLead(true));
        
        document.addEventListener('keydown', (event) => {
            const activeScreen = document.querySelector('.screen.active');
            if (!activeScreen) return;
            switch (activeScreen.id) {
                case 'salesScreen':
                    this.tryGenerateLead(true);
                    break;
                case 'accountScreen':
                    this.developLead(true);
                    break;
            }
        });

        DOM.staffForHire.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.name) {
                this.hireStaff(e.target.dataset.type, e.target.dataset.name);
            }
        });

        DOM.upgradesContainer.addEventListener('click', e => {
            const button = e.target.closest('button[data-upgrade]');
            if (button) {
                const upgradeKey = button.dataset.upgrade;
                const categoryKey = button.closest('[data-category]').dataset.category;
                this.buyUpgrade(categoryKey, upgradeKey);
            }
        });

        DOM.manualSaveBtn.addEventListener('click', () => {
            this.save();
            const originalText = DOM.manualSaveBtn.textContent;
            DOM.manualSaveBtn.textContent = 'Saved!';
            setTimeout(() => { DOM.manualSaveBtn.textContent = originalText; }, 1500);
        });
        DOM.resetProgressBtn.addEventListener('click', () => this.reset());
        
        DOM.toggleOfflineProgress.addEventListener('click', () => {
            this.settings.offlineProgress = !this.settings.offlineProgress;
            this.renderSettings();
        });
        DOM.toggleStaffAnimation.addEventListener('click', () => {
            this.settings.staffTextAnimation = !this.settings.staffTextAnimation;
            this.renderSettings();
        });

        DOM.welcomeModal.closeBtn.addEventListener('click', () => DOM.welcomeModal.el.classList.add('hidden'));
        DOM.eventModal.closeBtn.addEventListener('click', () => DOM.eventModal.el.classList.add('hidden'));
        DOM.eventDetailsModal.closeBtn.addEventListener('click', () => DOM.eventDetailsModal.el.classList.add('hidden'));
        
        const timer = DOM.activeEventTimer.el;
        timer.onmouseover = () => this.showEventDetails();
        timer.onclick = () => this.showEventDetails();
    }
    
    applyCoffeeMachineListeners() {
        const setupHold = (btn, action) => {
            const startHold = (e) => {
                e.preventDefault();
                if (this.holdInterval) clearInterval(this.holdInterval);
                action();
                this.holdInterval = setInterval(action, 100);
            };
            const stopHold = () => clearInterval(this.holdInterval);

            btn.onmousedown = startHold;
            btn.onmouseup = stopHold;
            btn.onmouseleave = stopHold;
            btn.ontouchstart = startHold;
            btn.ontouchend = stopHold;
        };
        setupHold(DOM.generateLeadBtn, () => this.tryGenerateLead(true));
        setupHold(DOM.developLeadBtn, () => this.developLead(true));
    }

    showScreen(id) {
        DOM.screens.forEach(screen => screen.classList.toggle('active', screen.id === id));
        DOM.navButtons.querySelectorAll('button').forEach(btn => {
            const isActive = btn.dataset.screen === id;
            btn.classList.toggle('bg-blue-500', isActive);
            btn.classList.toggle('text-white', isActive);
            btn.classList.toggle('bg-gray-200', !isActive);
            btn.classList.toggle('text-gray-700', !isActive);
        });
    }

    start() {
        this.setupEventListeners();
        if (this.upgrades.coffeeMachine.purchased) {
            this.applyCoffeeMachineListeners();
        }
        this.restartIntervals();
        this.renderAll();
        setInterval(() => this.mainLoop(), 1000);
    }
}

window.onload = () => {
    const game = new MonetizationGame();
    game.start();
};
</script>
</body>
</html>
