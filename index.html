<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Monetization Simulator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
      user-select: none; /* Prevents text selection on the whole page */
      -webkit-user-select: none; /* For Safari */
    }
    .screen { display: none; }
    .active { display: block; }
    #achievement-popup, #welcome-back-modal, #event-modal, #event-details-modal {
        transition: opacity 0.5s, transform 0.5s;
    }
    .feedback-popup {
        position: absolute;
        pointer-events: none;
        animation: fade-out-up 1s forwards;
    }
    @keyframes fade-out-up {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-30px); }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Main Container -->
  <div class="container mx-auto max-w-4xl p-4 relative">

    <!-- Header -->
    <header class="bg-gray-800 text-white p-4 rounded-lg shadow-lg mb-4">
      <h1 class="text-3xl font-bold text-center">Monetization Simulator</h1>
    </header>

    <!-- Global Stats Bar -->
    <div class="bg-gray-900 text-white p-3 rounded-lg shadow-md mb-4 sticky top-2 z-50 flex justify-around items-center text-center">
      <div>
        <span class="text-sm text-gray-400">Leads</span>
        <p class="text-xl font-semibold" id="globalLeadCount">0</p>
      </div>
      <div>
        <span class="text-sm text-gray-400">Money</span>
        <p class="text-xl font-semibold">$<span id="globalMoneyCount">0.00</span></p>
      </div>
      <div>
        <span class="text-sm text-gray-400">Rate</span>
        <p class="text-xl font-semibold">$<span id="globalRate">0.00</span>/s</p>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div id="nav-buttons" class="bg-white rounded-lg shadow-md p-2 mb-4 flex flex-wrap justify-center gap-2">
      <button onclick="showScreen('salesScreen')" class="px-4 py-2 rounded-md bg-blue-500 text-white font-semibold hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">Sales</button>
      <button onclick="showScreen('accountScreen')" class="px-4 py-2 rounded-md bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Accounts</button>
      <button onclick="showScreen('staffScreen')" class="px-4 py-2 rounded-md bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Staff</button>
      <button onclick="showScreen('upgradesScreen')" class="px-4 py-2 rounded-md bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Upgrades</button>
      <button onclick="showScreen('achievementsScreen')" class="px-4 py-2 rounded-md bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Achievements</button>
      <button onclick="showScreen('statsScreen')" class="px-4 py-2 rounded-md bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Statistics</button>
    </div>

    <!-- Sales Screen -->
    <div id="salesScreen" class="screen active p-4 bg-white rounded-lg shadow-md">
      <h2 class="text-2xl font-bold mb-4">Sales Screen</h2>
      <button id="generateLeadBtn" class="w-full md:w-auto px-6 py-3 rounded-lg bg-green-500 text-white font-bold text-lg shadow-md hover:bg-green-600 transition-transform transform hover:scale-105" onclick="tryGenerateLead()">Generate Lead</button>
      <div class="mt-4 text-xl">Leads: <span id="leadCount" class="font-bold">0</span></div>
      <div id="emailText" class="mt-4 p-4 h-48 bg-gray-900 text-green-400 font-mono rounded-lg overflow-y-auto text-left whitespace-pre-wrap shadow-inner"></div>
    </div>

    <!-- Accounts Screen -->
    <div id="accountScreen" class="screen p-4 bg-white rounded-lg shadow-md">
      <h2 class="text-2xl font-bold mb-4">Accounts Screen</h2>
      <button id="developLeadBtn" class="w-full md:w-auto px-6 py-3 rounded-lg bg-indigo-500 text-white font-bold text-lg shadow-md hover:bg-indigo-600 transition-transform transform hover:scale-105" onclick="developLead()">Develop Lead</button>
      <div class="w-full bg-gray-200 rounded-full h-6 mt-4 overflow-hidden shadow-inner">
        <div id="progressBar" class="bg-indigo-600 h-6 rounded-full transition-all duration-200" style="width: 0%"></div>
      </div>
      <div class="mt-4 text-xl">Money: $<span id="moneyCount" class="font-bold">0.00</span></div>
      <div id="adScriptText" class="mt-4 p-4 h-48 bg-gray-900 text-cyan-400 font-mono rounded-lg overflow-y-auto text-left whitespace-pre-wrap shadow-inner"></div>
    </div>

    <!-- Staff Screen -->
    <div id="staffScreen" class="screen p-4 bg-white rounded-lg shadow-md">
      <h2 class="text-2xl font-bold mb-4">Staff</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <h3 class="text-xl font-semibold mb-2">Hired Staff</h3>
            <ul id="hiredStaffList" class="list-disc list-inside bg-gray-100 p-3 rounded-lg min-h-[100px]"></ul>
        </div>
        <div>
            <div class="staff-category mb-4">
              <h3 class="text-xl font-semibold mb-2">Sales</h3>
              <div class="staff-list flex flex-wrap gap-2" id="salesStaffList"></div>
            </div>
            <div class="staff-category mb-4">
              <h3 class="text-xl font-semibold mb-2">Accounts</h3>
              <div class="staff-list flex flex-wrap gap-2" id="accountsStaffList"></div>
            </div>
            <div class="staff-category">
              <h3 class="text-xl font-semibold mb-2">Products</h3>
              <div class="staff-list flex flex-wrap gap-2" id="productsStaffList"></div>
            </div>
        </div>
      </div>
    </div>

    <!-- Upgrades Screen -->
    <div id="upgradesScreen" class="screen p-4 bg-white rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-4">Upgrades</h2>
        <div class="upgrade-category mb-6">
            <h3 class="text-xl font-semibold border-b-2 border-gray-200 pb-2 mb-3">Sales Upgrades</h3>
            <div id="salesUpgradesList" class="space-y-3"></div>
        </div>
        <div class="upgrade-category mb-6">
            <h3 class="text-xl font-semibold border-b-2 border-gray-200 pb-2 mb-3">Accounts Upgrades</h3>
            <div id="accountsUpgradesList" class="space-y-3"></div>
        </div>
        <div class="upgrade-category">
            <h3 class="text-xl font-semibold border-b-2 border-gray-200 pb-2 mb-3">Global Upgrades</h3>
            <div id="globalUpgradesList" class="space-y-3"></div>
        </div>
    </div>
    
    <!-- Achievements Screen -->
    <div id="achievementsScreen" class="screen p-4 bg-white rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-4">Achievements</h2>
        <div id="achievementsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        <div class="mt-8 text-center">
            <button id="resetProgressBtn" class="px-4 py-2 rounded-md bg-red-600 text-white font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400">Reset Progress</button>
        </div>
    </div>

    <!-- Statistics Screen -->
    <div id="statsScreen" class="screen p-4 bg-white rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-4">Statistics</h2>
        <div id="statisticsList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>

  </div>
  
  <!-- Achievement Popup -->
  <div id="achievement-popup" class="fixed bottom-5 right-5 bg-gray-900 text-white p-4 rounded-lg shadow-2xl opacity-0 transform translate-y-10 pointer-events-none">
      <h3 class="font-bold text-lg text-yellow-400" id="achievement-title"></h3>
      <p class="text-sm" id="achievement-desc"></p>
  </div>

  <!-- Welcome Back Modal -->
    <div id="welcome-back-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <h2 class="text-2xl font-bold mb-4">Welcome Back!</h2>
            <p>While you were away, your team earned:</p>
            <p class="text-xl font-semibold my-2" id="offline-earnings"></p>
            <button id="close-welcome-modal" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-md">Great!</button>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm relative mx-4">
            <button id="close-event-modal" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold mb-2" id="event-title"></h2>
            <p class="my-4" id="event-description"></p>
            <div id="event-choices" class="mt-4 space-y-2 sm:space-y-0 sm:space-x-2 flex flex-col sm:flex-row justify-center"></div>
        </div>
    </div>

    <!-- Event Details Modal (for timer hover) -->
    <div id="event-details-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm relative mx-4">
            <button id="close-event-details-modal" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold mb-2" id="event-details-title"></h2>
            <p class="my-4" id="event-details-description"></p>
        </div>
    </div>

    <!-- Active Event Timer -->
    <div id="active-event-timer" class="fixed bottom-5 left-5 bg-gray-900 text-white p-3 rounded-lg shadow-2xl hidden z-40 cursor-pointer">
        <h4 class="font-bold text-md" id="active-event-title"></h4>
        <p class="text-sm text-center" id="active-event-time-left"></p>
    </div>


  <script>
    // --- GAME STATE VARIABLES ---
    let leads = 0, money = 0, developClicks = 0, passiveIncome = 0, totalMoneyEarned = 0;
    let emailCharIndex = 0, adCharIndex = 0;
    let leadGenerationChance = 0.01;
    let clicksToDevelopLead = 100;
    let incomePerLead = 0.01;
    let holdInterval = null;
    let salesStaffCost = 5;
    let accountsStaffCost = 10;
    let gameStats = {
        totalManualClicks: 0,
        totalLeadsGenerated: 0,
        gameStartTime: Date.now(),
        playTime: 0
    };
    let eventCooldown = 180;
    let activeEvent = null;

    // --- CONTENT & CONFIG ---
    const emailContent = `Dear Valued Client,\n\nWe hope this message finds you well. I'm writing to follow up on our previous conversation regarding the exciting monetization opportunities available to you...`;
    const adScriptContent = `// Monetization Script\nfunction showAd() {\n  const ad = document.createElement('div');\n  ad.className = 'ad-banner';\n  ad.innerText = 'This space is monetized!';\n  document.body.appendChild(ad);\n}\nsetInterval(showAd, 5000);`;
    let hiredStaff = new Set();
    const staffButtons = {};
    const staffMembers = {
      sales: ['Artyom', 'Alan', 'Aruna', 'Dora', 'Syrym’, ‘Aidos’, ‘Alimzhan’, ‘Anna’, ‘Bolat’, ‘Yerbol’, ‘Madi’],
      accounts: ['Azret', 'Asiya', 'Daniil', 'Aizhan', 'Amir', 'Akzhan’, ‘Anuar’, ‘Hakim’, ‘Saniya’, ‘Sanzhar’],
      products: ['Emil']
    };

    let upgrades = {
      // Sales
      betterLeadForms: { level: 0, cost: 1, costMultiplier: 5, chanceIncrease: 0.001 },
      referralProgram: { level: 0, cost: 15, costMultiplier: 3, interval: null },
      aggressiveFollowup: { level: 0, cost: 7, costMultiplier: 3, chance: 0 },
      leadMagnet: { level: 0, cost: 50, costMultiplier: 10, multiplier: 1 },
      betterEmailSubject: { level: 0, cost: 20, costMultiplier: 3 },
      // Accounts
      asiyasHelp: { level: 0, cost: 5, costMultiplier: 5, clicksReduction: 10 },
      secondMonitor: { purchased: false, cost: 10 },
      newAdNetworks: { level: 0, cost: 10, costMultiplier: 3, incomeBonus: 0.1 },
      backgroundMusic: { level: 0, cost: 100, costMultiplier: 10 },
      cpmOptimization: { level: 0, cost: 500, costMultiplier: 3, chance: 0 },
      // Global
      nytPuzzles: { purchased: false, cost: 15, multiplier: 1.5 },
      corporateCulture: { purchased: false, cost: 50 },
      sycGlobal: { purchased: false, cost: 25, multiplier: 1.2 },
      coffeeMachine: { purchased: false, cost: 100 },
      amirsAutomation: { purchased: false, cost: 1000 }
    };
    
    let achievements = {
        mukhtarSatisfied: { name: "Mukhtar is satisfied", description: "Earn $50 total.", unlocked: false, condition: () => totalMoneyEarned >= 50 },
        mukhtarHappy: { name: "Mukhtar is happy", description: "Earn $100 total.", unlocked: false, condition: () => totalMoneyEarned >= 100 },
        mukhtarReallyHappy: { name: "Mukhtar is REALLY happy", description: "Earn $1,000 total.", unlocked: false, condition: () => totalMoneyEarned >= 1000 },
        someonePromoted: { name: "Someone is getting promoted", description: "Earn $5,000 total.", unlocked: false, condition: () => totalMoneyEarned >= 5000 },
        syc: { name: "100% СУЦ", description: "Earn $10,000 total.", unlocked: false, condition: () => totalMoneyEarned >= 10000 },
        buyMyUSDT: { name: "Buy my USDT", description: "Hire Emil.", unlocked: false, condition: () => hiredStaff.has('Emil') },
        shapkaGang: { name: "Шапка gang", description: "Hire all staff.", unlocked: false, condition: () => hiredStaff.size === (staffMembers.sales.length + staffMembers.accounts.length + staffMembers.products.length) }
        doshyrakMoney: { name: "Doshyrak Money", description: "Reach an income rate of $1.00/s.", unlocked: false, condition: () => passiveIncome >= 1 },
        sideHustle: { name: "Side Hustle", description: "Reach an income rate of $10.00/s.", unlocked: false, condition: () => passiveIncome >= 10 },
        theOnePercent: { name: "The 1%", description: "Reach an income rate of $100.00/s.", unlocked: false, condition: () => passiveIncome >= 100 },
        fullPipeline: { name: "Full Pipeline", description: "Have 1,000 leads at the same time.", unlocked: false, condition: () => leads >= 1000 },
        leadHoarder: { name: "Lead Hoarder", description: "Generate 10,000 leads in total.", unlocked: false, condition: () => gameStats.totalLeadsGenerated >= 10000 },
        salesDivision: { name: "Sales Division", description: "Hire all staff members from the Sales category.", unlocked: false, condition: () => staffMembers.sales.every(name => hiredStaff.has(name)) },
        accountsDepartment: { name: "Accounts Department", description: "Hire all staff members from the Accounts category.", unlocked: false, condition: () => staffMembers.accounts.every(name => hiredStaff.has(name)) },
        middleManagement: { name: "Middle Management", description: "Have 10 total staff members hired.", unlocked: false, condition: () => hiredStaff.size >= 10 },
        coffeeConnoisseur: { name: "Coffee Connoisseur", description: "Purchase the 'Coffee Machine' upgrade.", unlocked: false, condition: () => upgrades.coffeeMachine.purchased },
        automationExpert: { name: "Automation Expert", description: "Purchase the 'Amir's Automation' upgrade.", unlocked: false, condition: () => upgrades.amirsAutomation.purchased },
        technologicalAdvancement: { name: "Technological Advancement", description: "Purchase 10 different upgrades.", unlocked: false, condition: () => {
            let count = 0;
            for (const key in upgrades) {
                if ((upgrades[key].level && upgrades[key].level > 0) || upgrades[key].purchased) {
                    count++;
                }
            }
            return count >= 10;
        }},
        maximalist: { name: "Maximalist", description: "Purchase 25 different upgrades.", unlocked: false, condition: () => {
            let count = 0;
            for (const key in upgrades) {
                if ((upgrades[key].level && upgrades[key].level > 0) || upgrades[key].purchased) {
                    count++;
                }
            }
            return count >= 25;
        }},
        isYourWristOk: { name: "Is your wrist ok?", description: "Manually click 10,000 times.", unlocked: false, condition: () => gameStats.totalManualClicks >= 10000 },
        notABugAFeature: { name: "It's Not a Bug, It's a Feature", description: "Experience a 'Server Crash' event.", unlocked: false, condition: () => gameStats.eventsExperienced.has('serverCrash') },
        stonks: { name: "Stonks", description: "Experience a 'Bull Market' event.", unlocked: false, condition: () => gameStats.eventsExperienced.has('bullMarket') }
    };

    let salesStaffCount = 0, accountStaffCount = 0, productStaffCount = 0;
    const staffIntervals = [];
    let gameLoopInterval = null;

    // --- SAVE/LOAD LOGIC ---
    function saveGame() {
        const gameState = {
            leads, money, developClicks, passiveIncome, totalMoneyEarned,
            emailCharIndex, adCharIndex, leadGenerationChance, clicksToDevelopLead,
            incomePerLead, salesStaffCost, accountsStaffCost,
            hiredStaff: Array.from(hiredStaff),
            upgrades,
            achievements,
            gameStats,
            salesStaffCount, accountStaffCount, productStaffCount,
            lastSavedTime: Date.now(),
            activeEvent, eventCooldown
        };
        localStorage.setItem('monetizationSimSave', JSON.stringify(gameState));
    }

    function loadGame() {
        const savedData = localStorage.getItem('monetizationSimSave');
        if (!savedData) return;

        const gameState = JSON.parse(savedData);
        
        leads = gameState.leads || 0;
        money = gameState.money || 0;
        developClicks = gameState.developClicks || 0;
        passiveIncome = gameState.passiveIncome || 0;
        totalMoneyEarned = gameState.totalMoneyEarned || 0;
        emailCharIndex = gameState.emailCharIndex || 0;
        adCharIndex = gameState.adCharIndex || 0;
        leadGenerationChance = gameState.leadGenerationChance || 0.01;
        clicksToDevelopLead = gameState.clicksToDevelopLead || 100;
        incomePerLead = gameState.incomePerLead || 0.01;
        salesStaffCost = gameState.salesStaffCost || 5;
        accountsStaffCost = gameState.accountsStaffCost || 10;
        salesStaffCount = gameState.salesStaffCount || 0;
        accountStaffCount = gameState.accountStaffCount || 0;
        productStaffCount = gameState.productStaffCount || 0;
        eventCooldown = gameState.eventCooldown || 180;
        activeEvent = gameState.activeEvent || null;
        
        Object.assign(upgrades, gameState.upgrades);
        Object.assign(achievements, gameState.achievements);
        Object.assign(gameStats, gameState.gameStats);
        
        hiredStaff = new Set(gameState.hiredStaff || []);

        const lastSavedTime = gameState.lastSavedTime || Date.now();
        const timeDiffSeconds = Math.floor((Date.now() - lastSavedTime) / 1000);
        if (timeDiffSeconds > 5) {
            const offlineEarnings = passiveIncome * timeDiffSeconds * 0.5;
            money += offlineEarnings;
            totalMoneyEarned += offlineEarnings;
            showWelcomeBackModal(offlineEarnings);
        }
    }

    function resetGame() {
        if (confirm("Are you sure you want to reset all your progress? This cannot be undone.")) {
            localStorage.removeItem('monetizationSimSave');
            location.reload();
        }
    }

    // --- UI & DISPLAY FUNCTIONS ---
    function updateGlobalStats() {
      document.getElementById('globalLeadCount').textContent = leads;
      document.getElementById('globalMoneyCount').textContent = money.toFixed(2);
      document.getElementById('globalRate').textContent = passiveIncome.toFixed(2);
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      
      const navButtons = document.querySelectorAll('#nav-buttons button');
      navButtons.forEach(btn => {
          btn.classList.remove('bg-blue-500', 'text-white');
          btn.classList.add('bg-gray-200', 'text-gray-700');
      });
      
      const activeButton = Array.from(navButtons).find(btn => btn.getAttribute('onclick') === `showScreen('${id}')`);
      if(activeButton) {
          activeButton.classList.add('bg-blue-500', 'text-white');
          activeButton.classList.remove('bg-gray-200', 'text-gray-700');
      }
    }

    function createFeedbackPopup(text, element) {
        const rect = element.getBoundingClientRect();
        const popup = document.createElement('div');
        popup.textContent = text;
        popup.className = 'feedback-popup font-bold text-lg';
        popup.style.left = `${rect.left + rect.width / 2 - 20}px`;
        popup.style.top = `${rect.top - 30}px`;
        if (text.includes('+')) popup.style.color = 'green';
        document.body.appendChild(popup);
        setTimeout(() => popup.remove(), 1000);
    }

    function showWelcomeBackModal(earnings) {
        if (earnings <= 0) return;
        document.getElementById('offline-earnings').textContent = `$${earnings.toFixed(2)}`;
        document.getElementById('welcome-back-modal').classList.remove('hidden');
    }

    // --- CORE GAME LOGIC ---
    function tryGenerateLead(isManualClick = true) {
      if (isManualClick) gameStats.totalManualClicks++;
      const performAction = () => {
        let leadsGained = 0;
        if (Math.random() < leadGenerationChance) {
            leadsGained = upgrades.leadMagnet.multiplier;
            if (activeEvent && activeEvent.key === 'viralMarketing') leadsGained *= 5;
            leads += leadsGained;
            gameStats.totalLeadsGenerated += leadsGained;
            if (isManualClick) createFeedbackPopup(`+${leadsGained} Lead`, document.getElementById('generateLeadBtn'));
        }
        if (isManualClick && Math.random() < upgrades.aggressiveFollowup.chance) {
            developLead(false);
        }
        if (emailCharIndex >= emailContent.length) {
            emailCharIndex = 0;
            document.getElementById('emailText').textContent = '';
        }
        document.getElementById('emailText').textContent += emailContent.charAt(emailCharIndex++);
      };
      
      const clicks = isManualClick && upgrades.corporateCulture.purchased ? 2 : 1;
      for (let i = 0; i < clicks; i++) {
        performAction();
      }

      if (!isManualClick && upgrades.amirsAutomation.purchased) {
        performAction();
      }

      updateGlobalStats();
    }

    function developLead(isManualClick = true) {
      if (leads <= 0) return;
      if (isManualClick) gameStats.totalManualClicks++;
      
      const performAction = () => {
        let clicks = 1;
        if (isManualClick) {
            clicks *= upgrades.secondMonitor.purchased ? 2 : 1;
            clicks *= upgrades.corporateCulture.purchased ? 2 : 1;
        }
        developClicks += clicks;

        if (developClicks >= clicksToDevelopLead) {
            let incomeFromLead = incomePerLead;
            if (upgrades.sycGlobal.purchased) {
                incomeFromLead *= upgrades.sycGlobal.multiplier;
            }
            if (Math.random() < upgrades.cpmOptimization.chance) {
                incomeFromLead *= 2;
            }
            if(activeEvent && activeEvent.key === 'bullMarket') incomeFromLead *= 2;

            passiveIncome += incomeFromLead;
            developClicks -= clicksToDevelopLead;
            leads--;
            if (isManualClick) createFeedbackPopup(`+$${incomeFromLead.toFixed(2)}/s`, document.getElementById('developLeadBtn'));
        }
        if (isManualClick) {
            if (adCharIndex >= adScriptContent.length) {
                adCharIndex = 0;
                document.getElementById('adScriptText').textContent = '';
            }
            document.getElementById('adScriptText').textContent += adScriptContent.charAt(adCharIndex++);
        }
      };

      performAction();
      if (!isManualClick && upgrades.amirsAutomation.purchased) {
        performAction();
      }
      
      document.getElementById('progressBar').style.width = (developClicks / clicksToDevelopLead * 100) + "%";
      updateGlobalStats();
    }

    function hireStaff(name, type, button) {
      if (hiredStaff.has(name)) return;
      let cost;
      if (type === 'sales') cost = salesStaffCost;
      else if (type === 'accounts') cost = accountsStaffCost;
      else if (type === 'products') cost = 100;

      if (money < cost) {
        alert("Not enough money to hire " + name);
        return;
      }
      money -= cost;
      
      hiredStaff.add(name);
      if (type === 'sales') {
        salesStaffCount++;
        salesStaffCost *= 3;
        recalculateLeadChance();
      } else if (type === 'accounts') {
        accountStaffCount++;
        accountsStaffCost *= 3;
      } else if (type === 'products') {
        productStaffCount++;
        passiveIncome += 5;
      }
      
      updateFullStaffUI();
      updateGlobalStats();
      checkAchievements();
    }
    
    function checkUnlocks() {
        if (hiredStaff.has('Azret')) {
            if (staffButtons['Artyom']) staffButtons['Artyom'].style.display = 'inline-block';
        }
        if (hiredStaff.has('Artyom')) {
            if (staffButtons['Asiya']) staffButtons['Asiya'].style.display = 'inline-block';
        }
        if (hiredStaff.has('Asiya')) {
            staffMembers.sales.forEach(name => {
                if (name !== 'Artyom' && staffButtons[name]) staffButtons[name].style.display = 'inline-block';
            });
            staffMembers.accounts.forEach(name => {
                if (name !== 'Azret' && name !== 'Asiya' && staffButtons[name]) staffButtons[name].style.display = 'inline-block';
            });
        }

        const allSalesHired = staffMembers.sales.every(name => hiredStaff.has(name));
        const allAccountsHired = staffMembers.accounts.every(name => hiredStaff.has(name));
        if (allSalesHired && allAccountsHired && !hiredStaff.has('Emil') && !staffButtons['Emil']) {
            const btn = createStaffButton('Emil', 'products');
            document.getElementById('productsStaffList').appendChild(btn);
            updateStaffButtonPrices();
        }
    }

    function updateStaffButtonPrices() {
      for (const name in staffButtons) {
        if (hiredStaff.has(name)) continue;
        const btn = staffButtons[name];
        let cost;
        if (staffMembers.sales.includes(name)) cost = salesStaffCost;
        else if (staffMembers.accounts.includes(name)) cost = accountsStaffCost;
        else cost = 100;
        btn.textContent = `Hire ${name} ($${cost})`;
      }
    }

    function createStaffButton(name, type) {
        const btn = document.createElement('button');
        btn.className = 'px-3 py-1.5 rounded-md bg-yellow-400 text-yellow-900 font-semibold hover:bg-yellow-500 text-sm';
        staffButtons[name] = btn;
        btn.onclick = () => hireStaff(name, type, btn);
        return btn;
    }

    function createAllStaffButtons() {
        staffMembers.sales.forEach(name => {
            const btn = createStaffButton(name, 'sales');
            document.getElementById('salesStaffList').appendChild(btn);
        });
        staffMembers.accounts.forEach(name => {
            const btn = createStaffButton(name, 'accounts');
            document.getElementById('accountsStaffList').appendChild(btn);
        });
    }

    function updateFullStaffUI() {
        document.getElementById('hiredStaffList').innerHTML = '';
        hiredStaff.forEach(staffName => {
            const li = document.createElement('li');
            let type = 'products';
            if (staffMembers.sales.includes(staffName)) type = 'sales';
            else if (staffMembers.accounts.includes(staffName)) type = 'accounts';
            li.textContent = `${staffName} (${type})`;
            li.className = 'text-gray-700';
            document.getElementById('hiredStaffList').appendChild(li);

            if (staffButtons[staffName]) {
                staffButtons[staffName].disabled = true;
                staffButtons[staffName].textContent = 'Hired';
                staffButtons[staffName].classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        });
        
        for (const name in staffButtons) {
            if (name !== 'Azret') {
                staffButtons[name].style.display = 'none';
            }
        }
        checkUnlocks();
        updateStaffButtonPrices();
    }

    function recalculateLeadChance() {
        const base = 0.01;
        const betterFormsBonus = upgrades.betterLeadForms.level * upgrades.betterLeadForms.chanceIncrease;
        const emailSubjectBonus = 0.01 * salesStaffCount * upgrades.betterEmailSubject.level;
        leadGenerationChance = base + betterFormsBonus + emailSubjectBonus;
        renderSalesUpgrades();
    }

    // --- UPGRADE LOGIC ---
    function buyUpgrade(upgradeKey) {
        const upgrade = upgrades[upgradeKey];
        if (money < upgrade.cost) {
            alert("Not enough money!");
            return false;
        }
        money -= upgrade.cost;
        return true;
    }

    function buyBetterLeadForms() {
        if (!buyUpgrade('betterLeadForms')) return;
        upgrades.betterLeadForms.level++;
        upgrades.betterLeadForms.cost *= upgrades.betterLeadForms.costMultiplier;
        recalculateLeadChance();
        updateGlobalStats();
    }

    function buyReferralProgram() {
        if (!buyUpgrade('referralProgram')) return;
        upgrades.referralProgram.level++;
        upgrades.referralProgram.cost *= upgrades.referralProgram.costMultiplier;
        renderSalesUpgrades();
        updateGlobalStats();
    }

    function buyAggressiveFollowup() {
        if (!buyUpgrade('aggressiveFollowup')) return;
        upgrades.aggressiveFollowup.level++;
        upgrades.aggressiveFollowup.cost *= upgrades.aggressiveFollowup.costMultiplier;
        upgrades.aggressiveFollowup.chance += 0.05;
        renderSalesUpgrades();
        updateGlobalStats();
    }

    function buyLeadMagnet() {
        if (!buyUpgrade('leadMagnet')) return;
        upgrades.leadMagnet.level++;
        upgrades.leadMagnet.cost *= upgrades.leadMagnet.costMultiplier;
        upgrades.leadMagnet.multiplier *= 2;
        renderSalesUpgrades();
        updateGlobalStats();
    }

    function buyBetterEmailSubject() {
        if (!buyUpgrade('betterEmailSubject')) return;
        upgrades.betterEmailSubject.level++;
        upgrades.betterEmailSubject.cost *= upgrades.betterEmailSubject.costMultiplier;
        recalculateLeadChance();
        updateGlobalStats();
    }
    
    function buyAsiyasHelp() {
        if (clicksToDevelopLead <= 10) { alert("Maxed out!"); return; }
        if (!buyUpgrade('asiyasHelp')) return;
        upgrades.asiyasHelp.level++;
        upgrades.asiyasHelp.cost *= upgrades.asiyasHelp.costMultiplier;
        clicksToDevelopLead -= upgrades.asiyasHelp.clicksReduction;
        if (clicksToDevelopLead < 10) clicksToDevelopLead = 10;
        renderAccountsUpgrades();
        updateGlobalStats();
    }

    function buySecondMonitor() {
        if (upgrades.secondMonitor.purchased) return;
        if (!buyUpgrade('secondMonitor')) return;
        upgrades.secondMonitor.purchased = true;
        renderAccountsUpgrades();
        updateGlobalStats();
    }

    function buyNewAdNetworks() {
        if (!buyUpgrade('newAdNetworks')) return;
        upgrades.newAdNetworks.level++;
        upgrades.newAdNetworks.cost *= upgrades.newAdNetworks.costMultiplier;
        incomePerLead += upgrades.newAdNetworks.incomeBonus;
        renderAccountsUpgrades();
        updateGlobalStats();
    }

    function buyBackgroundMusic() {
        if (!buyUpgrade('backgroundMusic')) return;
        upgrades.backgroundMusic.level++;
        upgrades.backgroundMusic.cost *= upgrades.backgroundMusic.costMultiplier;
        renderAccountsUpgrades();
        updateGlobalStats();
    }

    function buyCpmOptimization() {
        if (!buyUpgrade('cpmOptimization')) return;
        upgrades.cpmOptimization.level++;
        upgrades.cpmOptimization.cost *= upgrades.cpmOptimization.costMultiplier;
        upgrades.cpmOptimization.chance += 0.2;
        if (upgrades.cpmOptimization.chance > 1) upgrades.cpmOptimization.chance = 1;
        renderAccountsUpgrades();
        updateGlobalStats();
    }

    function buyNytPuzzles() {
        if (upgrades.nytPuzzles.purchased) return;
        if (!buyUpgrade('nytPuzzles')) return;
        upgrades.nytPuzzles.purchased = true;
        upgrades.betterLeadForms.chanceIncrease *= upgrades.nytPuzzles.multiplier;
        upgrades.asiyasHelp.clicksReduction = Math.round(upgrades.asiyasHelp.clicksReduction * upgrades.nytPuzzles.multiplier);
        recalculateLeadChance();
        renderAccountsUpgrades();
        renderGlobalUpgrades();
        updateGlobalStats();
    }

    function buyCorporateCulture() {
        if (upgrades.corporateCulture.purchased) return;
        if (!buyUpgrade('corporateCulture')) return;
        upgrades.corporateCulture.purchased = true;
        renderGlobalUpgrades();
        updateGlobalStats();
    }

    function buySycGlobal() {
        if (upgrades.sycGlobal.purchased) return;
        if (!buyUpgrade('sycGlobal')) return;
        upgrades.sycGlobal.purchased = true;
        renderGlobalUpgrades();
        updateGlobalStats();
    }

    function buyAmirsAutomation() {
        if (upgrades.amirsAutomation.purchased) return;
        if (!buyUpgrade('amirsAutomation')) return;
        upgrades.amirsAutomation.purchased = true;
        renderGlobalUpgrades();
        updateGlobalStats();
    }

    function applyCoffeeMachineListeners() {
        const genLeadBtn = document.getElementById('generateLeadBtn');
        const devLeadBtn = document.getElementById('developLeadBtn');

        genLeadBtn.onmousedown = () => startHold(() => tryGenerateLead(true));
        genLeadBtn.onmouseup = stopHold;
        genLeadBtn.onmouseleave = stopHold;
        genLeadBtn.ontouchstart = (e) => { e.preventDefault(); startHold(() => tryGenerateLead(true)); };
        genLeadBtn.ontouchend = stopHold;

        devLeadBtn.onmousedown = () => startHold(() => developLead(true));
        devLeadBtn.onmouseup = stopHold;
        devLeadBtn.onmouseleave = stopHold;
        devLeadBtn.ontouchstart = (e) => { e.preventDefault(); startHold(() => developLead(true)); };
        devLeadBtn.ontouchend = stopHold;
    }

    function buyCoffeeMachine() {
        if (upgrades.coffeeMachine.purchased) return;
        if (!buyUpgrade('coffeeMachine')) return;
        upgrades.coffeeMachine.purchased = true;
        applyCoffeeMachineListeners();
        renderGlobalUpgrades();
        updateGlobalStats();
    }

    function startHold(action) {
        if (holdInterval) clearInterval(holdInterval);
        action();
        holdInterval = setInterval(action, 100);
    }

    function stopHold() {
        clearInterval(holdInterval);
    }
    
    // --- ACHIEVEMENT LOGIC ---
    function checkAchievements() {
        for (const key in achievements) {
            const ach = achievements[key];
            if (!ach.unlocked && ach.condition()) {
                ach.unlocked = true;
                showAchievementPopup(ach);
                renderAchievements();
            }
        }
    }

    function showAchievementPopup(achievement) {
        const popup = document.getElementById('achievement-popup');
        document.getElementById('achievement-title').textContent = achievement.name;
        document.getElementById('achievement-desc').textContent = achievement.description;
        
        popup.classList.remove('opacity-0', 'translate-y-10');
        popup.classList.add('opacity-100', 'translate-y-0');

        setTimeout(() => {
            popup.classList.remove('opacity-100', 'translate-y-0');
            popup.classList.add('opacity-0', 'translate-y-10');
        }, 4000);
    }

    function renderAchievements() {
        const container = document.getElementById('achievementsList');
        container.innerHTML = '';
        for (const key in achievements) {
            const ach = achievements[key];
            const item = document.createElement('div');
            item.className = 'p-4 rounded-lg shadow-sm';
            if (ach.unlocked) {
                item.classList.add('bg-yellow-100', 'border', 'border-yellow-400');
                item.innerHTML = `<h4 class="font-bold text-yellow-800">${ach.name}</h4><p class="text-sm text-yellow-700">${ach.description}</p>`;
            } else {
                item.classList.add('bg-gray-200');
                item.innerHTML = `<h4 class="font-bold text-gray-500">Locked Achievement</h4><p class="text-sm text-gray-400">???</p>`;
            }
            container.appendChild(item);
        }
    }
    // --- EVENT SYSTEM LOGIC ---
    const events = {
        viralMarketing: { 
            title: "Viral Marketing Campaign", 
            description: (name) => `${name}’s latest email campaign went viral on social media! The leads are pouring in.`,
            effectDescription: "For the next 60 seconds, every lead generation action produces 5x the normal amount of leads.",
            duration: 60,
            type: 'good'
        },
        bullMarket: {
            title: "Bull Market",
            description: () => "The market is hot! Advertisers are paying a premium for ad space.",
            effectDescription: "All income from developing leads is doubled for the next 90 seconds.",
            duration: 90,
            type: 'good'
        },
        productivityGuru: {
            title: "Productivity Guru Visits",
            description: () => "A famous инфоцыган visited the office and motivated the team!",
            effectDescription: "All staff members work 50% faster for the next 3 minutes.",
            duration: 180,
            type: 'good'
        },
        foundInvoice: {
            title: "Found an Old Invoice",
            description: (name) => `While cleaning out a filing cabinet, ${name} found an old, unpaid invoice from a client.`,
            effectDescription: "Instantly gain a lump sum of money equal to 10% of your current balance.",
            duration: 0,
            type: 'good'
        },
        abTest: {
            title: "Successful A/B Test",
            description: (name) => `${name} ran an A/B test on a new ad format, and it's a huge success!`,
            effectDescription: "The base income per lead is temporarily increased by +$0.50 for the next 2 minutes.",
            duration: 120,
            type: 'good'
        },
        serverCrash: {
            title: "Server Crash!",
            description: () => "Oh no! Reports has crashed, halting all operations.",
            type: 'choice',
            choices: [
                { text: "Pay $500", action: () => { if(money >= 500) money -= 500; else activeEvent.timeLeft = 0; } },
                { text: "Wait 60s", action: () => { activeEvent.duration = 60; activeEvent.timeLeft = 60; updateActiveEventTimer(); } }
            ]
        },
        adNetworkOutage: {
            title: "Ad Network Outage",
            description: () => "One of your biggest ad networks is experiencing a global outage.",
            effectDescription: "The money earned per lead is halved for the next 90 seconds.",
            duration: 90,
            type: 'bad'
        },
        teamBurnout: {
            title: "Team Burnout",
            description: (name) => `${name} is feeling overworked and exhausted after a long week.`,
            effectDescription: "All staff members work 25% slower for the next 3 minutes.",
            duration: 180,
            type: 'bad'
        },
        officeExpense: {
            title: "Unexpected Office Expense",
            description: () => "The water cooler broke down and needs an immediate, expensive repair!",
            effectDescription: "Instantly lose 5% of your current money.",
            duration: 0,
            type: 'bad'
        },
        negativePR: {
            title: "Negative PR",
            description: () => "A competitor published a negative article about your company, hurting your reputation.",
            effectDescription: "Your chance to generate a lead is reduced by 50% for the next 2 minutes.",
            duration: 120,
            type: 'bad'
        }
    };

    function triggerRandomEvent() {
        const eventKeys = Object.keys(events);
        const randomKey = eventKeys[Math.floor(Math.random() * eventKeys.length)];
        const event = events[randomKey];
        
        let description = event.description();
        if (randomKey === 'viralMarketing' || randomKey === 'teamBurnout') {
            const salesStaff = [...hiredStaff].filter(s => staffMembers.sales.includes(s));
            description = salesStaff.length > 0 ? event.description(salesStaff[Math.floor(Math.random() * salesStaff.length)]) : event.description("Someone");
        }
        if (randomKey === 'foundInvoice' || randomKey === 'abTest') {
             const accountStaff = [...hiredStaff].filter(s => staffMembers.accounts.includes(s));
             description = accountStaff.length > 0 ? event.description(accountStaff[Math.floor(Math.random() * accountStaff.length)]) : event.description("Someone");
        }

        document.getElementById('event-title').textContent = event.title;
        document.getElementById('event-description').textContent = description;
        const choicesContainer = document.getElementById('event-choices');
        choicesContainer.innerHTML = '';

        if (event.type === 'choice') {
            event.choices.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice.text;
                button.className = 'px-4 py-2 rounded-md bg-gray-300 hover:bg-gray-400';
                button.onclick = () => {
                    choice.action();
                    document.getElementById('event-modal').classList.add('hidden');
                };
                choicesContainer.appendChild(button);
            });
        } else {
             const okButton = document.createElement('button');
             okButton.textContent = "Okay";
             okButton.className = 'px-4 py-2 rounded-md bg-blue-500 text-white hover:bg-blue-600';
             okButton.onclick = () => {
                startEvent(randomKey);
                document.getElementById('event-modal').classList.add('hidden');
             };
             choicesContainer.appendChild(okButton);
        }
        
        document.getElementById('event-modal').classList.remove('hidden');
        eventCooldown = 180 + Math.random() * 120; // Reset cooldown to 3-5 minutes
    }
    
    function startEvent(key) {
        const event = events[key];
        if (event.duration > 0) {
            activeEvent = { key: key, timeLeft: event.duration, duration: event.duration };
            updateActiveEventTimer();
            document.getElementById('active-event-timer').classList.remove('hidden');
        } else {
            // Instant effect events
            if (key === 'foundInvoice') money += money * 0.10;
            if (key === 'officeExpense') money *= 0.95;
        }
    }

    function endEvent(key) {
        activeEvent = null;
        document.getElementById('active-event-timer').classList.add('hidden');
    }

    function updateActiveEventTimer() {
        if (!activeEvent) return;
        const timerEl = document.getElementById('active-event-timer');
        const titleEl = document.getElementById('active-event-title');
        const timeLeftEl = document.getElementById('active-event-time-left');
        
        const event = events[activeEvent.key];
        titleEl.textContent = event.title;
        
        const minutes = Math.floor(activeEvent.timeLeft / 60);
        const seconds = (activeEvent.timeLeft % 60).toString().padStart(2, '0');
        timeLeftEl.textContent = `${minutes}:${seconds}`;
    }

    function showEventDetails() {
        if (!activeEvent) return;
        const event = events[activeEvent.key];
        document.getElementById('event-details-title').textContent = event.title;
        document.getElementById('event-details-description').textContent = event.effectDescription;
        document.getElementById('event-details-modal').classList.remove('hidden');
    }
    // --- RENDER UPGRADES & STATS ---
    function createUpgradeElement(details) {
        const item = document.createElement('div');
        item.className = 'bg-gray-50 p-4 rounded-lg shadow-sm flex justify-between items-center';
        item.innerHTML = `
            <div>
              <h4 class="font-bold text-lg">${details.name} ${details.level !== undefined ? `<span class="text-sm font-normal bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full">${details.level}</span>` : ''}</h4>
              ${details.desc.map(d => `<p class="text-sm text-gray-600">${d}</p>`).join('')}
            </div>
            <div class="text-right flex-shrink-0 ml-4">
              <button class="px-4 py-2 rounded-md ${details.buttonClass} text-white font-semibold ${details.buttonHover}">Buy</button>
              <p class="text-sm font-semibold mt-1">Cost: $${details.cost.toFixed(2)}</p>
            </div>
        `;
        const button = item.querySelector('button');
        button.onclick = details.onclick;
        if (details.isMaxed || details.isPurchased) {
            button.disabled = true;
            button.textContent = details.isPurchased ? 'Purchased' : 'Maxed';
            button.className = 'px-4 py-2 rounded-md bg-gray-400 cursor-not-allowed text-white font-semibold';
        }
        return item;
    }

    function renderSalesUpgrades() {
      const container = document.getElementById('salesUpgradesList');
      container.innerHTML = '';
      
      container.appendChild(createUpgradeElement({
          name: 'Better Lead Forms', level: upgrades.betterLeadForms.level,
          desc: [`Increases manual lead generation chance by ${(upgrades.betterLeadForms.chanceIncrease * 100).toFixed(2)}pp.`, `Current total chance: ${(leadGenerationChance * 100).toFixed(2)}%`],
          cost: upgrades.betterLeadForms.cost, onclick: buyBetterLeadForms, buttonClass: 'bg-green-500', buttonHover: 'hover:bg-green-600'
      }));
      container.appendChild(createUpgradeElement({
          name: 'Lead Magnet', level: upgrades.leadMagnet.level,
          desc: [`Manual clicks generate ${upgrades.leadMagnet.multiplier}x leads.`],
          cost: upgrades.leadMagnet.cost, onclick: buyLeadMagnet, buttonClass: 'bg-green-500', buttonHover: 'hover:bg-green-600'
      }));
      container.appendChild(createUpgradeElement({
          name: 'Better Email Subject', level: upgrades.betterEmailSubject.level,
          desc: [`+1% bonus lead chance per Sales staff.`],
          cost: upgrades.betterEmailSubject.cost, onclick: buyBetterEmailSubject, buttonClass: 'bg-green-500', buttonHover: 'hover:bg-green-600'
      }));
      container.appendChild(createUpgradeElement({
          name: 'Referral Program', level: upgrades.referralProgram.level,
          desc: [`Passively generate ${upgrades.referralProgram.level} lead(s) every 10 seconds.`],
          cost: upgrades.referralProgram.cost, onclick: buyReferralProgram, buttonClass: 'bg-green-500', buttonHover: 'hover:bg-green-600'
      }));
      container.appendChild(createUpgradeElement({
          name: 'Aggressive Followup', level: upgrades.aggressiveFollowup.level,
          desc: [`+5% chance per click to instantly develop a lead.`, `Current chance: ${(upgrades.aggressiveFollowup.chance * 100).toFixed(0)}%`],
          cost: upgrades.aggressiveFollowup.cost, onclick: buyAggressiveFollowup, buttonClass: 'bg-green-500', buttonHover: 'hover:bg-green-600'
      }));
    }

    function renderAccountsUpgrades() {
        const container = document.getElementById('accountsUpgradesList');
        container.innerHTML = '';

        container.appendChild(createUpgradeElement({
            name: 'Asiya’s Help', level: upgrades.asiyasHelp.level,
            desc: [`Reduces clicks needed to develop a lead by ${upgrades.asiyasHelp.clicksReduction}.`, `Current clicks needed: ${clicksToDevelopLead}`],
            cost: upgrades.asiyasHelp.cost, onclick: buyAsiyasHelp, buttonClass: 'bg-indigo-500', buttonHover: 'hover:bg-indigo-600', isMaxed: clicksToDevelopLead <= 10
        }));
        container.appendChild(createUpgradeElement({
            name: '2nd Monitor',
            desc: [`Each manual click on "Develop Lead" counts as two.`],
            cost: upgrades.secondMonitor.cost, onclick: buySecondMonitor, buttonClass: 'bg-indigo-500', buttonHover: 'hover:bg-indigo-600', isPurchased: upgrades.secondMonitor.purchased
        }));
        container.appendChild(createUpgradeElement({
            name: 'New Ad Networks', level: upgrades.newAdNetworks.level,
            desc: [`Each developed lead earns +$${upgrades.newAdNetworks.incomeBonus.toFixed(2)} more.`, `Current income per lead: $${incomePerLead.toFixed(2)}`],
            cost: upgrades.newAdNetworks.cost, onclick: buyNewAdNetworks, buttonClass: 'bg-indigo-500', buttonHover: 'hover:bg-indigo-600'
        }));
        container.appendChild(createUpgradeElement({
            name: 'Background Music', level: upgrades.backgroundMusic.level,
            desc: [`+${upgrades.backgroundMusic.level} click/sec to each Accounts staff.`],
            cost: upgrades.backgroundMusic.cost, onclick: buyBackgroundMusic, buttonClass: 'bg-indigo-500', buttonHover: 'hover:bg-indigo-600'
        }));
        container.appendChild(createUpgradeElement({
            name: 'CPM Optimization', level: upgrades.cpmOptimization.level,
            desc: [`${(upgrades.cpmOptimization.chance * 100).toFixed(0)}% chance to double money from a lead.`],
            cost: upgrades.cpmOptimization.cost, onclick: buyCpmOptimization, buttonClass: 'bg-indigo-500', buttonHover: 'hover:bg-indigo-600', isMaxed: upgrades.cpmOptimization.chance >= 1
        }));
    }
    
    function renderGlobalUpgrades() {
        const container = document.getElementById('globalUpgradesList');
        container.innerHTML = '';

        container.appendChild(createUpgradeElement({
            name: 'NYT Puzzles',
            desc: [`Boosts Sales/Account upgrade effectiveness by x${upgrades.nytPuzzles.multiplier}.`, `One-time purchase.`],
            cost: upgrades.nytPuzzles.cost, onclick: buyNytPuzzles, buttonClass: 'bg-purple-500', buttonHover: 'hover:bg-purple-600', isPurchased: upgrades.nytPuzzles.purchased
        }));
        container.appendChild(createUpgradeElement({
            name: 'Corporate Culture',
            desc: [`All manual clicks count as two.`, `One-time purchase.`],
            cost: upgrades.corporateCulture.cost, onclick: buyCorporateCulture, buttonClass: 'bg-purple-500', buttonHover: 'hover:bg-purple-600', isPurchased: upgrades.corporateCulture.purchased
        }));
        container.appendChild(createUpgradeElement({
            name: 'СУЦ',
            desc: [`All income from developing leads is increased by 20%.`, `One-time purchase.`],
            cost: upgrades.sycGlobal.cost, onclick: buySycGlobal, buttonClass: 'bg-purple-500', buttonHover: 'hover:bg-purple-600', isPurchased: upgrades.sycGlobal.purchased
        }));
        container.appendChild(createUpgradeElement({
            name: 'Amir’s Automation',
            desc: [`Automated staff work twice as fast.`, `One-time purchase.`],
            cost: upgrades.amirsAutomation.cost, onclick: buyAmirsAutomation, buttonClass: 'bg-purple-500', buttonHover: 'hover:bg-purple-600', isPurchased: upgrades.amirsAutomation.purchased
        }));
        container.appendChild(createUpgradeElement({
            name: 'Coffee Machine',
            desc: [`Allows holding down the mouse button to click rapidly.`, `One-time purchase.`],
            cost: upgrades.coffeeMachine.cost, onclick: buyCoffeeMachine, buttonClass: 'bg-purple-500', buttonHover: 'hover:bg-purple-600', isPurchased: upgrades.coffeeMachine.purchased
        }));
    }

    function renderStatistics() {
        const container = document.getElementById('statisticsList');
        container.innerHTML = '';

        const createStat = (label, value) => {
            const statDiv = document.createElement('div');
            statDiv.className = 'bg-gray-200 p-3 rounded-lg';
            statDiv.innerHTML = `<span class="font-semibold">${label}:</span> ${value}`;
            container.appendChild(statDiv);
        };

        const formatTime = (seconds) => {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        };

        createStat('Total Money Earned', `$${totalMoneyEarned.toFixed(2)}`);
        createStat('Total Leads Generated', gameStats.totalLeadsGenerated);
        createStat('Manual Clicks', gameStats.totalManualClicks);
        createStat('Play Time', formatTime(gameStats.playTime));
    }

    // --- INITIALIZE GAME ---
    function initialize() {
        loadGame();

        createAllStaffButtons();
        updateFullStaffUI();
        
        recalculateLeadChance();
        renderAccountsUpgrades();
        renderGlobalUpgrades();
        renderAchievements();
        
        staffIntervals.forEach(clearInterval);
        hiredStaff.forEach(staffName => {
            if (staffMembers.sales.includes(staffName)) staffIntervals.push(setInterval(() => tryGenerateLead(false), 500));
            if (staffMembers.accounts.includes(staffName)) staffIntervals.push(setInterval(() => developLead(false), 500));
        });
        if (upgrades.referralProgram.level > 0) {
            staffIntervals.push(setInterval(() => { leads += upgrades.referralProgram.level; updateGlobalStats(); }, 10000));
        }
        if (upgrades.backgroundMusic.level > 0) {
            staffIntervals.push(setInterval(() => {
                const clicks = accountStaffCount * upgrades.backgroundMusic.level;
                for(let i=0; i<clicks; i++) developLead(false);
            }, 1000));
        }

        if (upgrades.coffeeMachine.purchased) {
            applyCoffeeMachineListeners();
        }

        gameLoopInterval = setInterval(gameLoop, 1000);
        
        updateGlobalStats();
        
        document.addEventListener('keydown', (event) => {
            const activeScreen = document.querySelector('.screen.active');
            if (!activeScreen) return;
            switch (activeScreen.id) {
                case 'salesScreen': tryGenerateLead(); break;
                case 'accountScreen': developLead(); break;
            }
        });

        document.getElementById('resetProgressBtn').onclick = resetGame;
        document.getElementById('close-welcome-modal').onclick = () => {
            document.getElementById('welcome-back-modal').classList.add('hidden');
        };
        document.getElementById('close-event-modal').onclick = () => {
            document.getElementById('event-modal').classList.add('hidden');
        };
        document.getElementById('close-event-details-modal').onclick = () => {
            document.getElementById('event-details-modal').classList.add('hidden');
        };
        const timer = document.getElementById('active-event-timer');
        timer.onmouseover = showEventDetails;
        timer.onclick = showEventDetails;
    }

    function gameLoop() {
        const incomeThisTick = passiveIncome;
        money += incomeThisTick;
        totalMoneyEarned += incomeThisTick;
        
        gameStats.playTime++;
        renderStatistics();

        if (activeEvent) {
            activeEvent.timeLeft--;
            updateActiveEventTimer();
            if (activeEvent.timeLeft <= 0) {
                endEvent(activeEvent.key);
            }
        } else {
            eventCooldown--;
            if (eventCooldown <= 0) {
                triggerRandomEvent();
            }
        }
        updateGlobalStats();
    }

    window.onload = initialize;
  </script>
</body>
</html>
